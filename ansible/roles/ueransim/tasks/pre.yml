- name: Update packages
  ansible.builtin.command: apt update -y
  become: yes

- name: Variables that are common across all OS types
  include_vars: "{{ lookup('first_found', dependencies) }}"
  vars:
    dependencies:
      files:
        - common.yml
      paths:
        - 'vars'

- name: Load a variable file based on the OS type, or a default if not found. Using free-form to specify the file.
  include_vars: "{{ lookup('first_found', dependencies) }}"
  vars:
    dependencies:
      files:
        - "{{ ansible_facts['distribution'] }}.yml"
        - default.yml
      paths:
        - 'vars'

- name: Install compile packages for EURANSIM
  ansible.builtin.package:
    name: "{{ common_packages }}"
    state: present
  become: yes

- name: Install compile packages for EURANSIM
  ansible.builtin.package:
    name: "{{ euransim_compile_packages }}"
    state: present
  become: yes

# Install cmake from source 'snap install cmake --classic' doesn't work on docker (M1 chipset) hence difficult to
# test locally when snap is failing
- name: Get CMake from source code and checkout to v3.21.1
  ansible.builtin.git:
    repo: 'https://github.com/Kitware/CMake'
    dest: /home/{{ user }}/CMake
    version: v3.21.1

- name: Bootstrap CMake
  ansible.builtin.command: ./bootstrap
  args:
    chdir: /home/{{ user }}/CMake

- name: Run make on CMake
  ansible.builtin.command: make
  args:
    chdir: /home/{{ user }}/CMake

- name: Install CMake
  community.general.make:
    chdir: /home/{{ user }}/CMake
    target: install
  become: yes